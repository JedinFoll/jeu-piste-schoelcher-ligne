<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jeu de Piste ‚Äì Sch≈ìlcher (Safe)</title>
<link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#f5f0e6; --marron:#5a2e0c; --marron-light:#7a3e21; --marron-dark:#2d1405; --parch:#fffdf4; --frame:#a97442; --shadow:rgba(0,0,0,.4); }
  *{box-sizing:border-box}
  body{font-family:'Trebuchet MS',Arial,sans-serif;background:var(--marron);margin:0;padding:24px;line-height:1.6;color:var(--ink)}
  .hero{background:var(--marron-light);border:3px solid var(--frame);border-radius:12px;padding:18px;margin-bottom:18px;box-shadow:4px 4px 8px var(--shadow)}
  .hero h1{font-family:'Alfa Slab One',serif;color:#f5e1c4;text-shadow:2px 2px 0 var(--marron-dark);margin:0 0 .5rem}
  .hero p{margin:.25rem 0 0;color:#f0e6d2}

  .card{background:var(--parch);border:2px solid var(--frame);border-radius:12px;padding:18px;margin-top:16px;color:#2d1a0a;box-shadow:3px 3px 6px var(--shadow)}
  h2{font-family:'Alfa Slab One',serif;color:var(--marron-dark)}
  .row{display:flex;gap:.6rem;flex-wrap:wrap;margin:.4rem 0 1rem;align-items:center}
  .btn{display:inline-block;padding:10px 16px;border-radius:8px;text-decoration:none;font-weight:700;border:2px solid var(--frame);background:#d4a373;color:#2d1a0a;cursor:pointer;box-shadow:2px 2px 4px var(--shadow);transition:transform .18s,background .18s,color .18s}
  .btn:hover{background:#b97d4e;color:#fffbea;transform:scale(1.05)}
  .btn.primary{background:var(--marron-light);color:#fffbea;border-color:var(--marron-dark)}
  .btn.primary:hover{background:var(--marron-dark)}
  input[type=text]{padding:10px 12px;border:2px solid var(--frame);border-radius:10px;min-width:220px;background:#fff;color:#2d1a0a}

  .badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;border:2px solid #ccc;font-size:.85rem}
  .ok{background:#e9fbe9;border-color:#bfe9bf;color:#164a16}
  .ko{background:#fff0f0;border-color:#f2c1c1;color:#7b1a1a}
  .mini-badge{font-size:.8rem;padding:.2rem .5rem;border-radius:999px;border:2px solid #c9c9c9}
  .mini-ok{background:#e9fbe9;border-color:#bfe9bf;color:#164a16}
  .mini-ko{background:#fff4f4;border-color:#f2c1c1;color:#7b1a1a}

  .hr{height:2px;margin:16px 0;background:#7a3e21}
  .enigme{display:none}

  #hintStart { color:#2d1a0a; background:#fff4d6; border:2px dashed #c28b2c; border-radius:8px; padding:6px 10px; display:none; }

  /* Journal technique */
  #log{white-space:pre-wrap; background:#111; color:#e7ffd8; padding:10px; border-radius:8px; font-family:ui-monospace,Consolas,monospace; font-size:.9rem; max-height:200px; overflow:auto; border:2px solid #2a2a2a}
  #log strong{color:#9be29b}
</style>
</head>
<body>
  <div class="hero">
    <h1>Jeu de Piste ‚Äì Sch≈ìlcher</h1>
    <p>Munis-toi de papier et crayon, scanne les QR codes et r√©sous les √©nigmes.</p>
  </div>

  <section class="card">
    <h2>Acc√®s au jeu</h2>

    <!-- Paiement -->
    <div class="row">
      <a class="btn primary" target="_blank" rel="noopener" href="https://www.paypal.com/ncp/payment/GLM2FB7ERYXKQ">üí≥ Payer 10 ‚Ç¨ (PayPal)</a>
    </div>

    <!-- Envoi SMS -->
    <div class="row">
      <input type="text" id="payerName" value="INARI" readonly />
      <input type="text" id="payerTxn" placeholder="N¬∞ de paiement PayPal" />
      <a id="btnEnvoyerSMS" class="btn" href="#">Envoyer la preuve par SMS</a>
    </div>
    <div id="smsHint" style="display:none; background:#fff4d6;border:2px dashed #c28b2c;border-radius:10px;padding:10px;color:#2d1a0a"></div>

    <!-- Pseudo + Code + Valider (bouton APR√àS les deux champs) -->
    <div class="row">
      <div class="row" style="gap:.4rem">
        <input type="text" id="playerName" placeholder="Ton pseudo (obligatoire)" />
        <span id="badgePseudo" class="mini-badge mini-ko">√† renseigner</span>
      </div>
      <div class="row" style="gap:.4rem">
        <input type="text" id="codeInput" placeholder="Entrer le code d‚Äôacc√®s re√ßu" />
        <span id="badgeCode" class="mini-badge mini-ko">√† renseigner</span>
      </div>
      <button class="btn" id="btnValiderCode" type="button" onclick="safeValidate()">Valider pseudo + code</button>
    </div>

    <!-- HUD -->
    <div class="row">
      <span class="badge ko" id="badge">verrouill√©</span>
      <span style="margin-left:8px;">‚è± Temps : <strong id="chrono">00:00:00</strong></span>
    </div>

    <div class="hr"></div>
    <div class="row">
      <button class="btn primary" id="btnCommencer" type="button" disabled onclick="safeStart()">Commencer le jeu</button>
      <span id="hintStart">Appuie sur ¬´ Commencer le jeu ¬ª pour afficher l‚Äô√ânigme 1.</span>
    </div>
  </section>

  <!-- √ânigmes -->
  <section id="bloc-enigmes" class="card" style="display:none;">
    <h2>√ânigmes</h2>
    <p>Seule l‚Äô√ânigme 1 est visible au d√©part. Pour d√©bloquer les suivantes, scanne les bons QR codes dans l‚Äôordre.</p>

    <article id="enigme1" class="enigme"><h3>√ânigme 1</h3><p><em>(Ton √âNIGME 1 ici)</em></p></article>
    <article id="enigme2" class="enigme"><h3>√ânigme 2</h3><p><em>(Ton √âNIGME 2 ici)</em></p></article>
    <article id="enigme3" class="enigme"><h3>√ânigme 3</h3><p><em>(Ton √âNIGME 3 ici)</em></p></article>
    <article id="enigme4" class="enigme"><h3>√ânigme 4</h3><p><em>(Ton √âNIGME 4 ici)</em></p></article>
    <article id="fin" class="enigme"><h3>Bravo üéâ</h3><p>Tu as termin√© le parcours !</p></article>
  </section>

  <!-- Journal technique -->
  <section class="card">
    <h2>Journal technique (aide au diagnostic)</h2>
    <div id="log"></div>
  </section>

<script>
/* =================== CONFIG MINIMALE =================== */
var ACCESS_CODES = ["SCHOELCHER-10"]; // ajoute d‚Äôautres codes si besoin
var CONTACT_PHONE = "+596696327693";
/* ======================================================= */

(function initSafe(){
  // Journal technique + capture d'erreurs
  var logEl = document.getElementById('log');
  function log(msg){ logEl.innerHTML += (msg + "\\n"); logEl.scrollTop = logEl.scrollHeight; }
  window.onerror = function(message, source, lineno, colno, error){
    log("‚ö†Ô∏è ERREUR JS: " + message + " (" + source + ":" + lineno + ")");
  };
  log("‚úÖ Script charg√©.");

  // Pr√©visualisation : champs pr√©sents ?
  ['playerName','codeInput','btnValiderCode','btnCommencer','badge'].forEach(function(id){
    if(!document.getElementById(id)){ log("‚ö†Ô∏è √âl√©ment manquant: " + id); }
  });

  // √âcoutes basiques (et aussi des onclick inline pour compat max)
  var pn = document.getElementById('playerName');
  if (pn && pn.addEventListener){
    pn.addEventListener('input', function(){ updateStartEnable(); previewBadges(); });
  }
  var ci = document.getElementById('codeInput');
  if (ci && ci.addEventListener){
    ci.addEventListener('input', function(){ previewBadges(); });
  }

  // SMS bouton
  var btnSMS = document.getElementById('btnEnvoyerSMS');
  if (btnSMS){
    btnSMS.addEventListener('click', function(e){
      var txn = (document.getElementById('payerTxn').value || '').trim();
      if(!txn){ alert("Entre ton N¬∞ de paiement PayPal."); e.preventDefault(); return; }
      var msg = "INARI - Paiement: " + txn;
      var num = CONTACT_PHONE.replace(/\\s+/g,'');
      var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      var isAndroid = /Android/i.test(navigator.userAgent);
      var href = isIOS ? ("sms:"+num+"&body="+encodeURIComponent(msg))
               : isAndroid ? ("smsto:"+num+"?body="+encodeURIComponent(msg))
               : ("sms:"+num+"?body="+encodeURIComponent(msg));
      btnSMS.setAttribute('href', href);
      setTimeout(function(){
        if(document.visibilityState === 'visible'){
          var hint = document.getElementById('smsHint');
          hint.style.display = 'block';
          hint.innerHTML = 'Si l‚Äôapp SMS ne s‚Äôest pas ouverte, envoie un SMS au <strong>'+CONTACT_PHONE+'</strong> avec :<br><pre>'+msg+'</pre>';
        }
      }, 1200);
    });
  }

  log("‚ÑπÔ∏è Pr√™t. Tape un pseudo + le code puis clique ¬´ Valider pseudo + code ¬ª.");
})();

/* ======== LOGIQUE ACC√àS ULTRA-COMPATIBLE ======== */
// Normalisation manuelle (pas de .normalize / pas de regex unicode)
// - Retire accents via remplacement simple
// - Retire espaces/underscores et divers tirets
// - Met en MAJUSCULES
function stripAccents(s){
  var map = {
    '√†':'a','√°':'a','√¢':'a','√§':'a','√£':'a','√•':'a','ƒÅ':'a',
    '√ß':'c',
    '√®':'e','√©':'e','√™':'e','√´':'e','ƒì':'e',
    '√¨':'i','√≠':'i','√Æ':'i','√Ø':'i','ƒ´':'i',
    '√±':'n',
    '√≤':'o','√≥':'o','√¥':'o','√∂':'o','√µ':'o','≈ç':'o',
    '√π':'u','√∫':'u','√ª':'u','√º':'u','≈´':'u',
    '√ø':'y',
    '√Ä':'A','√Å':'A','√Ç':'A','√Ñ':'A','√É':'A','√Ö':'A','ƒÄ':'A',
    '√á':'C',
    '√à':'E','√â':'E','√ä':'E','√ã':'E','ƒí':'E',
    '√å':'I','√ç':'I','√é':'I','√è':'I','ƒ™':'I',
    '√ë':'N',
    '√í':'O','√ì':'O','√î':'O','√ñ':'O','√ï':'O','≈å':'O',
    '√ô':'U','√ö':'U','√õ':'U','√ú':'U','≈™':'U',
    '≈∏':'Y'
  };
  var out = "", i, ch;
  for(i=0;i<s.length;i++){ ch = s.charAt(i); out += (map[ch] || ch); }
  return out;
}
function normalizeCode(raw){
  var s = stripAccents(raw || "");
  // retire espaces et underscores
  s = s.replace(/[\s_]+/g,'');
  // retire tirets les plus courants: - ‚Äì ‚Äî Ôπò Ôπ£ Ôºç
  s = s.replace(/[-‚Äì‚ÄîÔπòÔπ£Ôºç]+/g,'');
  return s.toUpperCase();
}
// set de codes autoris√©s
var ACCESS_SET = (function(){
  var set = {};
  for (var i=0;i<ACCESS_CODES.length;i++){
    set[ normalizeCode(ACCESS_CODES[i]) ] = true;
  }
  return set;
})();

function setAccess(ok){
  var badge = document.getElementById('badge');
  var btnStart = document.getElementById('btnCommencer');
  var bloc = document.getElementById('bloc-enigmes');
  if(ok){
    badge.textContent = "d√©verrouill√©";
    badge.className = "badge ok";
    btnStart.disabled = !document.getElementById('playerName').value.trim();
  }else{
    badge.textContent = "verrouill√©";
    badge.className = "badge ko";
    btnStart.disabled = true;
    if (bloc) bloc.style.display = "none";
  }
}

function previewBadges(){
  var pseudo = (document.getElementById('playerName').value||"").trim();
  var code   = (document.getElementById('codeInput').value||"").trim();
  var badgeP = document.getElementById('badgePseudo');
  var badgeC = document.getElementById('badgeCode');
  badgeP.textContent = pseudo ? "saisi" : "√† renseigner";
  badgeP.className = "mini-badge " + (pseudo ? "mini-ok" : "mini-ko");
  badgeC.textContent = code ? "saisi" : "√† renseigner";
  badgeC.className = "mini-badge " + (code ? "mini-ok" : "mini-ko");
}

function updateStartEnable(){
  var btnStart = document.getElementById('btnCommencer');
  var ok = document.getElementById('badge').className.indexOf('ok') !== -1;
  var hasPseudo = !!(document.getElementById('playerName').value||"").trim();
  btnStart.disabled = !(ok && hasPseudo);
}

// Appel√© par le bouton (et aussi via addEventListener si dispo)
function safeValidate(){
  var logEl = document.getElementById('log');
  function log(m){ logEl.innerHTML += (m+"\\n"); logEl.scrollTop = logEl.scrollHeight; }

  try{
    var pseudo = (document.getElementById('playerName').value||"").trim();
    var rawCode = (document.getElementById('codeInput').value||"").trim();
    if(!pseudo){ alert("Entre d‚Äôabord ton pseudo."); log("Pseudo manquant."); return; }
    if(!rawCode){ alert("Entre le code d‚Äôacc√®s."); log("Code manquant."); return; }

    var norm = normalizeCode(rawCode);
    log("Code saisi (normalis√©) = " + norm);

    if (!ACCESS_SET[norm]){
      alert("Code invalide ‚ùå");
      document.getElementById('badgeCode').textContent="invalide";
      document.getElementById('badgeCode').className="mini-badge mini-ko";
      log("Refus√© (pas dans ACCESS_SET).");
      return;
    }

    // OK ‚Üí badges + verrouillage + acc√®s
    document.getElementById('badgePseudo').textContent="‚úÖ Valid√©";
    document.getElementById('badgePseudo').className="mini-badge mini-ok";
    document.getElementById('badgeCode').textContent="‚úÖ Valid√©";
    document.getElementById('badgeCode').className="mini-badge mini-ok";

    document.getElementById('playerName').readOnly = true;
    document.getElementById('codeInput').readOnly   = true;
    document.getElementById('btnValiderCode').disabled = true;

    setAccess(true);
    updateStartEnable();

    // Indice + scroll vers le bouton Commencer
    document.getElementById('hintStart').style.display = "inline-block";
    document.getElementById('btnCommencer').scrollIntoView({behavior:'smooth', block:'center'});

    alert("‚úÖ Pseudo et code valid√©s. Appuie sur ¬´ Commencer le jeu ¬ª pour afficher l‚Äô√ânigme 1.");
    log("Validation OK ‚Üí acc√®s d√©verrouill√©.");
  }catch(e){
    log("‚ö†Ô∏è Exception: " + (e&&e.message?e.message:e));
  }
}

var startTime=null, timerInterval=null;
function fmt(sec){ function pad(x){return String(x).padStart(2,'0');} return pad(Math.floor(sec/3600))+":"+pad(Math.floor((sec%3600)/60))+":"+pad(Math.floor(sec%60)); }
function tick(){ if(startTime){ var s = Math.floor((Date.now()-startTime)/1000); document.getElementById('chrono').textContent = fmt(s); } }

function safeStart(){
  if (document.getElementById('btnCommencer').disabled) return;
  document.getElementById('hintStart').style.display = "none";
  document.getElementById('bloc-enigmes').style.display = "block";
  // Affiche uniquement Enigme 1
  var ids=["enigme1","enigme2","enigme3","enigme4","fin"];
  for (var i=0;i<ids.length;i++){
    var el=document.getElementById(ids[i]); if(el) el.style.display = (i===0?"block":"none");
  }
  // Chrono simple
  startTime = Date.now();
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(tick, 1000);
  tick();

  // Note dans le log
  var logEl = document.getElementById('log');
  logEl.innerHTML += "‚è± Chrono d√©marr√©. Enigme 1 affich√©e.\\n";
  logEl.scrollTop = logEl.scrollHeight;
}
</script>
</body>
</html>
