<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jeu de Piste ‚Äì Sch≈ìlcher</title>
<link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#f5f0e6; --marron:#5a2e0c; --marron-light:#7a3e21; --marron-dark:#2d1405; --frame:#a97442; --shadow:rgba(0,0,0,.4); }
  *{box-sizing:border-box}
  body{font-family:'Trebuchet MS',Arial,sans-serif;background:var(--marron);margin:0;padding:24px;line-height:1.6;color:var(--ink)}
  .hero{background:var(--marron-light);border:3px solid var(--frame);border-radius:12px;padding:18px;margin-bottom:18px;box-shadow:4px 4px 8px var(--shadow)}
  .hero h1{font-family:'Alfa Slab One',serif;color:#f5e1c4;text-shadow:2px 2px 0 var(--marron-dark);margin:0 0 .5rem}
  .hero p{margin:.25rem 0 0;color:#f0e6d2}

  .card{background:#fffdf4;border:2px solid var(--frame);border-radius:12px;padding:18px;margin-top:16px;color:#2d1a0a;box-shadow:3px 3px 6px var(--shadow)}
  h2{font-family:'Alfa Slab One',serif;color:var(--marron-dark)}
  .row{display:flex;gap:.6rem;flex-wrap:wrap;margin:.4rem 0 1rem;align-items:center}
  .btn{display:inline-block;padding:10px 16px;border-radius:8px;text-decoration:none;font-weight:700;border:2px solid var(--frame);background:#d4a373;color:#2d1a0a;cursor:pointer;box-shadow:2px 2px 4px var(--shadow);transition:transform .18s,background .18s,color .18s}
  .btn:hover{background:#b97d4e;color:#fffbea;transform:scale(1.05)}
  .btn.primary{background:var(--marron-light);color:#fffbea;border-color:var(--marron-dark)}
  .btn.primary:hover{background:var(--marron-dark)}
  input[type=text]{padding:10px 12px;border:2px solid var(--frame);border-radius:10px;min-width:220px;background:#fff;color:#2d1a0a}

  .badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;border:2px solid #ccc;font-size:.85rem}
  .ok{background:#e9fbe9;border-color:#bfe9bf;color:#164a16}
  .ko{background:#fff0f0;border-color:#f2c1c1;color:#7b1a1a}
  .mini-badge{font-size:.8rem;padding:.2rem .5rem;border-radius:999px;border:2px solid #c9c9c9}
  .mini-ok{background:#e9fbe9;border-color:#bfe9bf;color:#164a16}
  .mini-ko{background:#fff4f4;border-color:#f2c1c1;color:#7b1a1a}

  .map-wrap{position:relative;width:100%;overflow:auto;background:#faf3e0;border:2px solid #a97442;border-radius:12px}
  .map-frame{width:100%;height:min(80vh,700px);display:flex;align-items:center;justify-content:center}
  .map-img{max-height:100%;max-width:100%;display:block;border-radius:8px}

  .hr{height:2px;margin:16px 0;background:#7a3e21}
  .enigme{display:none}

  #scanModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  #scanBox{background:#fffef6;border-radius:12px;max-width:520px;width:100%;padding:16px;border:2px solid #a97442;box-shadow:4px 4px 10px var(--shadow)}
  video{width:100%;border-radius:10px;border:2px solid #a97442;background:#000}

  .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chip{background:#fff0cc;border:2px solid #e2b24c;border-radius:999px;padding:6px 12px;font-weight:700}

  .parchment{position:relative;background:radial-gradient(ellipse at 30% 20%,#fff6d9 0,#fff0c9 40%,#f6e4b6 70%,#ecd9a6 100%);border:1px solid #c9a96b;color:#3a240d;padding:18px 16px 16px;border-radius:10px;box-shadow:0 3px 12px rgba(0,0,0,.25),inset 0 0 40px rgba(125,72,23,.15)}
  .parchment h3{margin-top:0;font-family:'Alfa Slab One',serif;letter-spacing:.5px}
  .scan-row{margin-top:.6rem}
</style>
</head>
<body>
  <div class="hero">
    <h1>Jeu de Piste ‚Äì Sch≈ìlcher</h1>
    <p>Munis-toi de papier et crayon, scanne les QR codes et r√©sous les √©nigmes.</p>
  </div>

  <!-- Acc√®s -->
  <section class="card" id="acces">
    <h2>Acc√®s au jeu</h2>
    <div class="row">
      <a class="btn primary" target="_blank" rel="noopener"
         href="https://www.paypal.com/ncp/payment/GLM2FB7ERYXKQ">üí≥ Payer 10 ‚Ç¨ (PayPal)</a>
    </div>
    <div class="row">
      <input type="text" id="payerName" value="INARI" readonly />
      <input type="text" id="payerTxn" placeholder="N¬∞ de paiement PayPal" />
      <a id="btnEnvoyerSMS" class="btn" href="#">Envoyer la preuve par SMS</a>
    </div>
    <div id="smsHint" class="sms-hint" style="display:none;"></div>

    <div class="row">
      <div class="row" style="gap:.4rem">
        <input type="text" id="playerName" placeholder="Ton pseudo (obligatoire)" />
        <span id="badgePseudo" class="mini-badge mini-ko">√† renseigner</span>
      </div>
      <div class="row" style="gap:.4rem">
        <input type="text" id="codeInput" placeholder="Entrer le code d‚Äôacc√®s re√ßu" />
        <span id="badgeCode" class="mini-badge mini-ko">√† renseigner</span>
      </div>
      <button class="btn" id="btnValiderCode">Valider pseudo + code</button>
    </div>

    <div class="row hud">
      <span class="chip">‚è± Temps : <span id="chrono">00:00:00</span></span>
      <span>Statut : <span id="badge" class="badge ko">verrouill√©</span></span>
    </div>

    <div class="hr"></div>
    <div class="row">
      <button class="btn primary" id="btnCommencer" disabled>Commencer le jeu</button>
    </div>
  </section>

  <!-- Carte -->
  <section class="card">
    <h2>Carte du parcours</h2>
    <div class="map-wrap">
      <div class="map-frame">
        <img class="map-img" id="mapImg" src="carte-schoelcher.jpg" alt="Carte du jeu de piste √† Sch≈ìlcher">
      </div>
    </div>
  </section>

  <!-- √ânigmes -->
  <section id="bloc-enigmes" class="card" style="display:none;">
    <h2>√ânigmes</h2>
    <p>Chaque QR ne d√©bloque que son √©nigme d√©di√©e, dans l‚Äôordre.</p>

    <!-- ‚öôÔ∏è NOMS EXACTS DES PDF SUR TON D√âP√îT -->
    <script>
      window.ENIGME_FILES = {
        1: "enigme1.pdf",  // remplace par le nom exact si diff√©rent
        3: "enigme3.pdf"   // ex: "enigme3a.pdf" si c‚Äôest celui sur GitHub
      };
    </script>

    <!-- √ânigme 1 -->
    <article id="enigme1" class="enigme">
      <div class="parchment">
        <h3>üó∫Ô∏è √ânigme 1</h3>
        <p style="margin:0 0 .5rem"><a class="btn" id="e1link" href="#" target="_blank" rel="noopener">Ouvrir l‚Äô√ânigme 1 (PDF)</a></p>
        <iframe id="e1frame" src="" style="width:100%;height:520px;border:0;border-radius:10px;background:#fff" loading="lazy" title="√ânigme 1"></iframe>
      </div>
      <div class="row scan-row">
        <button class="btn" data-expects="ENIGME-2" onclick="scanNext(this)">
          Scanner le QR n¬∞1 ‚Üí √ânigme 2
        </button>
      </div>
    </article>

    <!-- √ânigme 2 -->
    <article id="enigme2" class="enigme">
      <div class="parchment">
        <h3>üåø √ânigme 2</h3>
        <p class="lead">Passage Ombrag√© ‚Äì Nature Tagu√©e</p>
        <p>Repr√©sentent ta prochaine destination.</p>
      </div>
      <div class="row scan-row">
        <button class="btn" data-expects="ENIGME-3" onclick="scanNext(this)">
          Scanner le QR n¬∞2 ‚Üí √ânigme 3
        </button>
      </div>
    </article>

    <!-- √ânigme 3 (PDF) -->
    <article id="enigme3" class="enigme">
      <div class="parchment">
        <h3>üîê √ânigme 3</h3>
        <object id="e3obj" data="" type="application/pdf" width="100%" height="520" style="border:0;border-radius:10px">
          <p>Impossible d‚Äôafficher le PDF. <a id="e3link" href="#" target="_blank" rel="noopener">Ouvrir l‚Äô√ânigme 3 (PDF)</a>.</p>
        </object>
      </div>
      <div class="row scan-row">
        <button class="btn" data-expects="ENIGME-4" onclick="scanNext(this)">
          Scanner le QR n¬∞3 ‚Üí √ânigme 4
        </button>
      </div>
    </article>

    <!-- Squelettes pour la suite -->
    <article id="enigme4" class="enigme"><div class="parchment"><h3>üß≠ √ânigme 4</h3></div><div class="row scan-row"><button class="btn" data-expects="ENIGME-5" onclick="scanNext(this)">Scanner le QR n¬∞4 ‚Üí √ânigme 5</button></div></article>
    <article id="enigme5" class="enigme"><div class="parchment"><h3>‚öì √ânigme 5</h3></div><div class="row scan-row"><button class="btn" data-expects="ENIGME-6" onclick="scanNext(this)">Scanner le QR n¬∞5 ‚Üí √ânigme 6</button></div></article>
    <article id="enigme6" class="enigme"><div class="parchment"><h3>üèõÔ∏è √ânigme 6</h3></div><div class="row scan-row"><button class="btn" data-expects="ENIGME-7" onclick="scanNext(this)">Scanner le QR n¬∞6 ‚Üí √ânigme 7</button></div></article>
    <article id="enigme7" class="enigme"><div class="parchment"><h3>üèÅ √ânigme 7</h3><p>Bravo !</p></div></article>
  </section>

  <!-- Scanner -->
  <div id="scanModal" role="dialog" aria-modal="true" style="display:none;">
    <div id="scanBox">
      <h3 style="font-family:'Alfa Slab One',serif;">Scanner un QR code</h3>
      <video id="video" playsinline muted></video>
      <div class="row" style="margin-top:.5rem">
        <button class="btn" id="btnFermerScan" type="button">Fermer</button>
      </div>
      <p id="scanMsg" class="muted" style="margin:6px 0 0;color:#7a3e21"></p>
      <p id="scanRaw" class="muted" style="margin:4px 0 0;color:#7a3e21;font-size:.9rem"></p>
    </div>
  </div>

  <!-- Classement -->
  <section class="card" id="classement">
    <h2>Classement ‚Äì Top 5</h2>
    <table id="boardTable">
      <thead><tr><th>#</th><th>Pseudo</th><th>Temps</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

<script>
  /* ===== CONFIG ACC√àS ===== */
  const CONTACT_PHONE = "+596696327693";
  const ACCESS_CODES  = ["SCHOELCHER-10"];
  const KEY_ACCESS="jp_access", KEY_PSEUDO="jp_player", KEY_STARTED="jp_started",
        KEY_UNLOCKED="jp_unlocked", KEY_START_TIME="jp_start_time";

  /* DOM */
  const $=s=>document.querySelector(s);
  const badge=$("#badge"), btnCommencer=$("#btnCommencer");
  const blocEnigmes=$("#bloc-enigmes"), codeInput=$("#codeInput"), btnValiderCode=$("#btnValiderCode");
  const playerNameInput=$("#playerName"), chronoEl=$("#chrono");
  const payerTxn=$("#payerTxn"), btnEnvoyerSMS=$("#btnEnvoyerSMS"), smsHint=$("#smsHint");
  const scanModal=$("#scanModal"), video=$("#video"), btnFermerScan=$("#btnFermerScan"), scanMsg=$("#scanMsg"), scanRaw=$("#scanRaw");

  /* Utils */
  function normalize(s){return (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[\s_\/\\]+/g,'').replace(/[-‚Äì‚ÄîÔπòÔπ£Ôºç]+/g,'').toUpperCase();}
  const ACCESS_SET=new Set(ACCESS_CODES.map(normalize));
  const hasAccess=()=>localStorage.getItem(KEY_ACCESS)==="1";
  function setAccessUI(ok){ if(ok){badge.textContent="d√©verrouill√©";badge.classList.remove("ko");badge.classList.add("ok");} else {badge.textContent="verrouill√©";badge.classList.remove("ok");badge.classList.add("ko");} updateStartButton(); }

  /* Chrono */
  let startTime=null, timerInterval=null;
  const pad=n=>String(n).padStart(2,"0");
  const fmt=s=>`${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(Math.floor(s%60))}`;
  function tick(){ if(startTime){ chronoEl.textContent=fmt(Math.floor((Date.now()-startTime)/1000)); } }
  function startChrono(){ if(timerInterval) clearInterval(timerInterval); if(!startTime) startTime=Date.now(); localStorage.setItem(KEY_START_TIME,String(startTime)); timerInterval=setInterval(tick,1000); tick(); }

  /* Progression */
  const order=["enigme1","enigme2","enigme3","enigme4","enigme5","enigme6","enigme7"];
  function getUnlocked(){ try{return JSON.parse(localStorage.getItem(KEY_UNLOCKED)||"[]");}catch(_){return[];} }
  function setUnlocked(arr){ localStorage.setItem(KEY_UNLOCKED, JSON.stringify(arr)); }
  function unlock(id){ const arr=getUnlocked(); if(!arr.includes(id)) arr.push(id); setUnlocked(arr); renderProgress(); scrollInto(id); }
  function renderProgress(){ const arr=getUnlocked(); if(localStorage.getItem(KEY_STARTED)==="1") blocEnigmes.style.display="block"; document.querySelectorAll(".enigme").forEach(e=>e.style.display="none"); arr.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display="block";});}
  function nextId(){ const arr=getUnlocked(); return order.find(id=>!arr.includes(id)) || "enigme7"; }
  function scrollInto(id){ const el=document.getElementById(id); if(el) el.scrollIntoView({behavior:'smooth',block:'start'}); }

  /* Acc√®s */
  function updateStartButton(){ const hasPseudo=!!(playerNameInput.value||"").trim(); btnCommencer.disabled=!hasPseudo||!hasAccess(); }
  playerNameInput.addEventListener("input", ()=>{ localStorage.setItem(KEY_PSEUDO, playerNameInput.value||""); updateStartButton(); });
  btnValiderCode.addEventListener("click", ()=>{ const pseudo=(playerNameInput.value||"").trim(); const entered=normalize(codeInput.value);
    if(!pseudo){alert("Entre ton pseudo.");return;}
    if(!ACCESS_SET.has(entered)){alert("Code invalide ‚ùå");return;}
    localStorage.setItem(KEY_PSEUDO,pseudo); localStorage.setItem(KEY_ACCESS,"1"); setAccessUI(true);
    playerNameInput.readOnly=true; codeInput.readOnly=true; btnValiderCode.disabled=true;
    alert("‚úÖ Acc√®s valid√©. Appuie sur ¬´ Commencer le jeu ¬ª.");
  });
  btnCommencer.addEventListener("click", ()=>{ if(btnCommencer.disabled) return;
    localStorage.setItem(KEY_STARTED,"1");
    const arr=getUnlocked(); if(!arr.includes("enigme1")) arr.push("enigme1"); setUnlocked(arr);
    renderProgress(); startChrono(); scrollInto("enigme1");
  });

  /* Monter les PDF √† partir des noms d√©clar√©s */
  (function mountPDFs(){
    const e1 = new URL((window.ENIGME_FILES&&ENIGME_FILES[1])||"enigme1.pdf", location.href).href;
    const e3 = new URL((window.ENIGME_FILES&&ENIGME_FILES[3])||"enigme3.pdf", location.href).href;
    const e1frame=document.getElementById("e1frame"), e1link=document.getElementById("e1link");
    if(e1frame) e1frame.src = e1 + "#view=FitH";
    if(e1link)  e1link.href = e1;
    const e3obj=document.getElementById("e3obj"), e3link=document.getElementById("e3link");
    if(e3obj)  e3obj.setAttribute("data", e3 + "#view=FitH");
    if(e3link) e3link.href = e3;
  })();

  /* --- Lecture stricte du num√©ro d'√©tape depuis n'importe quel QR --- */
  function extractStepNum(raw){
    function extractStepNum(raw){
    const s = String(raw||"").trim();

    // 1) Si c'est une URL -> on cherche dans query, chemin et hash
    try{
      const u = new URL(s);
      // param√®tres possibles: ?qr=, ?code=, ?step=, ?e=
      for (const k of ["qr","code","step","e"]) {
        const v = u.searchParams.get(k);
        if (v) {
          const m = String(v).toUpperCase().match(/(?:ENIGME[-\s]?)?([2-7])/);
          if (m) return Number(m[1]);
        }
      }
      // chercher dans le pathname ou le hash (#ENIGME-4, /ENIGME4/, /4, etc.)
      const ph = (u.pathname + " " + u.hash).toUpperCase();
      let m = ph.match(/ENIGME[-\s]?([2-7])/);
      if (m) return Number(m[1]);
      m = ph.match(/(?:^|\/)([2-7])(?:\/|$)/);
      if (m) return Number(m[1]);
    }catch(_){/* pas une URL */ }

    // 2) Cha√Æne "normale" : on cherche partout, pas seulement en fin
    const up = s.toUpperCase();
    let m = up.match(/ENIGME[-\s]?([2-7])/); if (m) return Number(m[1]);
    m = up.match(/\b(?:E|QR)[-\s]?([2-7])\b/); if (m) return Number(m[1]);
    m = up.match(/\b([2-7])\b/); if (m) return Number(m[1]);

    return null;
  }

    // Accepte : ENIGME-4, ENIGME 4, ENIGME4, E4, QR4, ?qr=ENIGME-4, ?qr=4, juste "4", etc.
    const s = String(raw||"").trim();
    try{ const u=new URL(s); const q=u.searchParams.get("qr"); if(q){ const n = q.toUpperCase().match(/(?:ENIGME-?)?([2-7])$/); if(n) return Number(n[1]); } }catch(e){}
    const up = s.toUpperCase().replace(/\s+/g,'');
    let m = up.match(/ENIGME-?([2-7])$/); if(m) return Number(m[1]);
    m = up.match(/^(?:E|QR)?([2-7])$/);    if(m) return Number(m[1]);
    return null;
  }
  function codeFromNum(n){ return `ENIGME-${n}`; }

  /* Scanner (STRICT par √©tape) */
  const QR_TO_STEP={ "ENIGME-2":"enigme2","ENIGME-3":"enigme3","ENIGME-4":"enigme4","ENIGME-5":"enigme5","ENIGME-6":"enigme6","ENIGME-7":"enigme7" };
  let stream=null, detector=null, rafId=null, expectedNow=null;
  window.scanNext = (btn)=>{
    if(!hasAccess()){ alert("Acc√®s requis. Merci de valider votre paiement."); return; }
    if(localStorage.getItem(KEY_STARTED)!=="1"){ alert("Commence le jeu d‚Äôabord."); return; }
    expectedNow = btn.getAttribute("data-expects") || null; // "ENIGME-x"
    openScan();
  };

  async function openScan(){
    scanMsg.textContent="Cadre le QR dans la vue. Valeur lue ci-dessous.";
    scanRaw.textContent="";
    scanModal.style.display="flex";
    try{
      if('BarcodeDetector' in window){ detector=new BarcodeDetector({formats:['qr_code']}); }
      else{
        const step = Number((expectedNow||"ENIGME-2").split("-")[1]||2);
        scanMsg.innerHTML = "Scanner int√©gr√© indisponible.<br>Utilise l‚Äôappareil photo : le QR doit ouvrir cette page avec <code>?qr="+codeFromNum(step)+"</code>.";
        return;
      }
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
      video.srcObject=stream; await video.play();
      tickScan();
    }catch(e){ scanMsg.textContent="Cam√©ra indisponible (permission ?)"; }
  }
  async function tickScan(){
    try{
      const codes=await detector.detect(video);
      if(codes && codes.length){
        const raw=(codes[0].rawValue||"").trim();
        scanRaw.textContent = "Lu : " + raw;
        const num = extractStepNum(raw); // 2..7 ou null
        const mustNum = Number((expectedNow||"ENIGME-2").split("-")[1]||2);

        if(num===mustNum){
          const targetId = QR_TO_STEP[codeFromNum(num)];
          unlock(targetId);
          alert(`√ânigme d√©bloqu√©e ‚úÖ (${targetId.toUpperCase()})`);
          closeScan(); return;
        }else{
          scanMsg.textContent = "Ce QR ne correspond pas √† cette √©tape. Attendu : "+codeFromNum(mustNum);
        }
      }
    }catch(_){}
    rafId=requestAnimationFrame(tickScan);
  }
  function closeScan(){ scanModal.style.display="none"; if(rafId){cancelAnimationFrame(rafId); rafId=null;} if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} }

  /* Paywall strict via ?qr=... */
  (function gateFromURL(){
    const params=new URLSearchParams(location.search); const q=params.get("qr");
    if(q) history.replaceState({}, "", location.pathname);
    if(!q) return;
    if(!hasAccess()){ alert("Acc√®s requis. Merci de valider votre paiement."); setAccessUI(false); return; }
    if(localStorage.getItem(KEY_STARTED)!=="1"){ localStorage.setItem(KEY_STARTED,"1"); const arr=getUnlocked(); if(!arr.includes("enigme1")){arr.push("enigme1"); setUnlocked(arr);} }
    const num = extractStepNum(q); if(!num){ alert("QR non reconnu via l‚ÄôURL."); return; }
    const targetId = QR_TO_STEP[codeFromNum(num)];
    const must = nextId();
    if(targetId!==must){ alert("Ce QR ne correspond pas √† cette √©tape."); return; }
    unlock(targetId); renderProgress(); scrollInto(targetId);
  })();

  /* Restauration */
  (function restore(){
    setAccessUI(hasAccess());
    const p = localStorage.getItem(KEY_PSEUDO)||""; if(p){ playerNameInput.value=p; playerNameInput.readOnly=hasAccess(); }
    if(hasAccess()){ codeInput.readOnly=true; btnValiderCode.disabled=true; }
    updateStartButton();
    if(localStorage.getItem(KEY_STARTED)==="1"){
      blocEnigmes.style.display="block";
      renderProgress();
      const t=parseInt(localStorage.getItem(KEY_START_TIME)||"0",10);
      if(t>0){ startTime=t; startChrono(); }
    }
  })();

  /* SMS INARI */
  const isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent), isAndroid=/Android/i.test(navigator.userAgent);
  function buildSmsMessage(){ const txn=(payerTxn.value||"").trim(); if(!txn){ alert("Entre ton N¬∞ de paiement PayPal."); return null; } return `INARI - Paiement: ${txn}`; }
  function smsHref(phone,text){ const num=phone.replace(/\s+/g,''); const body=encodeURIComponent(text); if(isIOS) return `sms:${num}&body=${body}`; if(isAndroid) return `smsto:${num}?body=${body}`; return `sms:${num}?body=${body}`; }
  document.getElementById("btnEnvoyerSMS").addEventListener("click",(e)=>{ const msg=buildSmsMessage(); if(!msg){e.preventDefault();return;} e.currentTarget.setAttribute("href", smsHref(CONTACT_PHONE,msg)); setTimeout(()=>{ if(document.visibilityState==="visible"){ smsHint.style.display="block"; smsHint.innerHTML=`Si l‚Äôapp SMS ne s‚Äôest pas ouverte, envoie un SMS au <strong>${CONTACT_PHONE}</strong> avec :<br><pre>${msg}</pre>`; } },1200); });
</script>
</body>
</html>
