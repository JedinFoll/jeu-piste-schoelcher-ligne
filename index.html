<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jeu de Piste ‚Äì Sch≈ìlcher</title>
<link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#f5f0e6; --marron:#5a2e0c; --marron-light:#7a3e21; --marron-dark:#2d1405; --parch:#fff9e9; --frame:#a97442; --shadow:rgba(0,0,0,.4); }
  *{box-sizing:border-box}
  body{font-family:'Trebuchet MS',Arial,sans-serif;background:var(--marron);margin:0;padding:24px;line-height:1.6;color:var(--ink)}
  .hero{background:var(--marron-light);border:3px solid var(--frame);border-radius:12px;padding:18px;margin-bottom:18px;box-shadow:4px 4px 8px var(--shadow)}
  .hero h1{font-family:'Alfa Slab One',serif;color:#f5e1c4;text-shadow:2px 2px 0 var(--marron-dark);margin:0 0 .5rem}
  .hero p{margin:.25rem 0 0;color:#f0e6d2}

  .card{background:#fffdf4;border:2px solid var(--frame);border-radius:12px;padding:18px;margin-top:16px;color:#2d1a0a;box-shadow:3px 3px 6px var(--shadow)}
  h2{font-family:'Alfa Slab One',serif;color:var(--marron-dark)}
  .row{display:flex;gap:.6rem;flex-wrap:wrap;margin:.4rem 0 1rem;align-items:center}
  .btn{display:inline-block;padding:10px 16px;border-radius:8px;text-decoration:none;font-weight:700;border:2px solid var(--frame);background:#d4a373;color:#2d1a0a;cursor:pointer;box-shadow:2px 2px 4px var(--shadow);transition:transform .18s,background .18s,color .18s}
  .btn:hover{background:#b97d4e;color:#fffbea;transform:scale(1.05)}
  .btn.primary{background:var(--marron-light);color:#fffbea;border-color:var(--marron-dark)}
  .btn.primary:hover{background:var(--marron-dark)}
  input[type=text]{padding:10px 12px;border:2px solid var(--frame);border-radius:10px;min-width:220px;background:#fff;color:#2d1a0a}

  .badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;border:2px solid #ccc;font-size:.85rem}
  .ok{background:#e9fbe9;border-color:#bfe9bf;color:#164a16}
  .ko{background:#fff0f0;border-color:#f2c1c1;color:#7b1a1a}
  .mini-badge{font-size:.8rem;padding:.2rem .5rem;border-radius:999px;border:2px solid #c9c9c9}
  .mini-ok{background:#e9fbe9;border-color:#bfe9bf;color:#164a16}
  .mini-ko{background:#fff4f4;border-color:#f2c1c1;color:#7b1a1a}

  .map-wrap{position:relative;width:100%;overflow:auto;background:#faf3e0;border:2px solid #a97442;border-radius:12px}
  .map-frame{width:100%;height:min(80vh,700px);display:flex;align-items:center;justify-content:center}
  .map-img{max-height:100%;max-width:100%;display:block;border-radius:8px}

  .hr{height:2px;margin:16px 0;background:#7a3e21}
  .enigme{display:none}

  /* Modal scan */
  #scanModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  #scanBox{background:#fffef6;border-radius:12px;max-width:520px;width:100%;padding:16px;border:2px solid #a97442;box-shadow:4px 4px 10px var(--shadow)}
  video{width:100%;border-radius:10px;border:2px solid #a97442;background:#000}

  .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chip{background:#fff0cc;border:2px solid #e2b24c;border-radius:999px;padding:6px 12px;font-weight:700}

  /* Effet parchemin */
  .parchment{
    position:relative;
    background: radial-gradient(ellipse at 30% 20%, #fff6d9 0%, #fff0c9 40%, #f6e4b6 70%, #ecd9a6 100%);
    border:1px solid #c9a96b; color:#3a240d; padding:18px 16px 16px; border-radius:10px;
    box-shadow: 0 3px 12px rgba(0,0,0,.25), inset 0 0 40px rgba(125,72,23,.15);
  }
  .parchment h3{margin-top:0;font-family:'Alfa Slab One',serif;letter-spacing:.5px}
  .parchment .lead{font-weight:700;font-style:italic;margin:.3rem 0 .6rem}
  .parchment .icon{font-size:1.2rem;margin-right:.35rem}
</style>
</head>
<body>
  <div class="hero">
    <h1>Jeu de Piste ‚Äì Sch≈ìlcher</h1>
    <p>Munis-toi de papier et crayon, scanne les QR codes et r√©sous les √©nigmes.</p>
  </div>

  <!-- Acc√®s -->
  <section class="card" id="acces">
    <h2>Acc√®s au jeu</h2>

    <!-- Paiement -->
    <div class="row">
      <a class="btn primary" target="_blank" rel="noopener"
         href="https://www.paypal.com/ncp/payment/GLM2FB7ERYXKQ">üí≥ Payer 10 ‚Ç¨ (PayPal)</a>
    </div>

    <!-- Preuve par SMS (INARI + N¬∞ paiement) -->
    <div class="row">
      <input type="text" id="payerName" value="INARI" readonly />
      <input type="text" id="payerTxn" placeholder="N¬∞ de paiement PayPal" />
      <a id="btnEnvoyerSMS" class="btn" href="#">Envoyer la preuve par SMS</a>
    </div>
    <div id="smsHint" class="sms-hint" style="display:none;"></div>

    <!-- Pseudo + Code + Valider -->
    <div class="row">
      <div class="row" style="gap:.4rem">
        <input type="text" id="playerName" placeholder="Ton pseudo (obligatoire)" />
        <span id="badgePseudo" class="mini-badge mini-ko">√† renseigner</span>
      </div>
      <div class="row" style="gap:.4rem">
        <input type="text" id="codeInput" placeholder="Entrer le code d‚Äôacc√®s re√ßu" />
        <span id="badgeCode" class="mini-badge mini-ko">√† renseigner</span>
      </div>
      <button class="btn" id="btnValiderCode">Valider pseudo + code</button>
    </div>

    <!-- HUD -->
    <div class="row hud">
      <span class="chip">‚è± Temps : <span id="chrono">00:00:00</span></span>
      <span>Statut : <span id="badge" class="badge ko">verrouill√©</span></span>
    </div>

    <div class="hr"></div>
    <div class="row">
      <button class="btn primary" id="btnCommencer" disabled>Commencer le jeu</button>
      <button class="btn" id="btnScanner" disabled>Scanner le QR code</button>
    </div>
  </section>

  <!-- Carte -->
  <section class="card">
    <h2>Carte du parcours</h2>
    <div class="map-wrap">
      <div class="map-frame">
        <img class="map-img" id="mapImg" src="carte-schoelcher.jpg" alt="Carte du jeu de piste √† Sch≈ìlcher">
      </div>
    </div>
  </section>

  <!-- √ânigmes -->
  <section id="bloc-enigmes" class="card" style="display:none;">
    <h2>√ânigmes</h2>
    <p id="txtVisibility">Seule l‚Äô√ânigme 1 est visible au d√©part. Pour d√©bloquer les suivantes, scanne les bons QR codes dans l‚Äôordre.</p>

    <article id="enigme1" class="enigme">
      <div class="parchment">
        <h3>üó∫Ô∏è √ânigme 1</h3>
        <p class="lead"><span class="icon">‚ö°Ô∏è</span>La sym√©trie t'emportera au premier endroit.</p>
        <p>L√† o√π l‚Äô√©lectricit√© est source d‚Äô√©nergie, tu trouveras l‚Äôessence de ta qu√™te.</p>
      </div>
    </article>

    <article id="enigme2" class="enigme">
      <div class="parchment">
        <h3>üåø √ânigme 2</h3>
        <p class="lead">Passage Ombrag√©<br>Nature Tagu√©e</p>
        <p>Repr√©sentent ta prochaine destination.</p>
      </div>
    </article>

    <article id="enigme3" class="enigme"><h3>√ânigme 3</h3><p><em>(Ton √âNIGME 3 ici)</em></p></article>
    <article id="enigme4" class="enigme"><h3>√ânigme 4</h3><p><em>(Ton √âNIGME 4 ici)</em></p></article>
    <article id="fin" class="enigme"><h3>Bravo üéâ</h3><p>Tu as termin√© le parcours !</p></article>
  </section>

  <!-- Scanner (vid√©o uniquement ‚Äî pas de saisie manuelle) -->
  <div id="scanModal" role="dialog" aria-modal="true">
    <div id="scanBox">
      <h3 style="font-family:'Alfa Slab One',serif;">Scanner un QR code</h3>
      <video id="video" playsinline muted></video>
      <div class="row">
        <button class="btn" id="btnFermerScan" type="button">Fermer</button>
      </div>
      <p id="scanMsg" class="muted" style="margin:6px 0 0;color:#7a3e21"></p>
    </div>
  </div>

  <!-- Classement -->
  <section class="card" id="classement">
    <h2>Classement ‚Äì Top 5</h2>
    <table id="boardTable">
      <thead><tr><th>#</th><th>Pseudo</th><th>Temps</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

<script>
  /* =================== CONFIG =================== */
  const CONTACT_PHONE = "+596696327693";
  const ACCESS_CODES  = ["SCHOELCHER-10"]; // codes valides
  const PLAYER_KEY    = "jp_player_name";
  const ACCESS_KEY    = "jp_access_granted"; // <- flag d'acc√®s
  const BOARD_KEY     = "jp_board";

  // Cha√Æne attendue dans les QR (tu peux en ajouter)
  const QR_FLOW = [
    { nextId:"enigme2", value:"ENIGME-2" },
    { nextId:"enigme3", value:"ENIGME-3" },
    { nextId:"enigme4", value:"ENIGME-4" },
    { nextId:"fin",     value:"FIN" }
  ];
  /* ============================================= */

  // Helpers DOM
  const $ = s => document.querySelector(s);
  const badge=$("#badge"), btnCommencer=$("#btnCommencer"), btnScanner=$("#btnScanner");
  const blocEnigmes=$("#bloc-enigmes"), codeInput=$("#codeInput"), btnValiderCode=$("#btnValiderCode");
  const playerNameInput=$("#playerName"), chronoEl=$("#chrono");
  const payerTxn=$("#payerTxn"), btnEnvoyerSMS=$("#btnEnvoyerSMS"), smsHint=$("#smsHint");

  // Normaliser code d'acc√®s
  function normalize(s){
    return (s||"")
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[\s_\/\\]+/g,'')
      .replace(/[-‚Äì‚ÄîÔπòÔπ£Ôºç]+/g,'')
      .toUpperCase();
  }
  const ACCESS_SET = new Set(ACCESS_CODES.map(normalize));
  function hasAccess(){ return localStorage.getItem(ACCESS_KEY)==="1"; }
  function grantAccess(){ localStorage.setItem(ACCESS_KEY,"1"); }
  function revokeAccess(){ localStorage.removeItem(ACCESS_KEY); }

  // Acc√®s (badge global)
  function setAccess(ok){
    if(ok){
      badge.textContent="d√©verrouill√©";
      badge.classList.remove("ko"); badge.classList.add("ok");
      updateStartButton();
    }else{
      badge.textContent="verrouill√©";
      badge.classList.remove("ok"); badge.classList.add("ko");
      btnCommencer.disabled=true; btnScanner.disabled=true; blocEnigmes.style.display="none";
    }
  }
  setAccess(hasAccess());

  // Chrono
  let startTime=null, timerInterval=null;
  const pad=x=>String(x).padStart(2,"0");
  const fmt=sec=>`${pad(Math.floor(sec/3600))}:${pad(Math.floor((sec%3600)/60))}:${pad(Math.floor(sec%60))}`;
  function tick(){ if(startTime) chronoEl.textContent=fmt(Math.floor((Date.now()-startTime)/1000)); }
  function startChrono(){ if(timerInterval)clearInterval(timerInterval); startTime=Date.now(); timerInterval=setInterval(tick,1000); tick(); }
  function stopChrono(){ if(!startTime)return; clearInterval(timerInterval); timerInterval=null; }

  // Classement Top 5
  function renderBoard(){
    const tbody = document.querySelector("#boardTable tbody"); tbody.innerHTML="";
    let board={}; try{ board = JSON.parse(localStorage.getItem(BOARD_KEY)||"{}"); }catch(_){}
    const sorted = Object.entries(board).sort((a,b)=>a[1]-b[1]).slice(0,5);
    if(!sorted.length){ tbody.innerHTML="<tr><td colspan='3'>Aucun joueur</td></tr>"; return; }
    sorted.forEach(([name,sec],i)=>{
      const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${name}</td><td>${fmt(sec)}</td>`;
      tbody.appendChild(tr);
    });
  }
  renderBoard();

  // Validation acc√®s
  function updateStartButton(){
    const hasPseudo = !!(playerNameInput.value||"").trim();
    btnCommencer.disabled = !hasPseudo || badge.classList.contains("ko");
  }
  playerNameInput.addEventListener("input", updateStartButton);

  btnValiderCode.addEventListener("click", ()=>{
    const pseudo = (playerNameInput.value||"").trim();
    const entered = normalize(codeInput.value);
    if(!pseudo){ alert("Entre d‚Äôabord ton pseudo."); return; }
    if(!entered){ alert("Entre le code d‚Äôacc√®s."); return; }
    if(!ACCESS_SET.has(entered)){ alert("Code invalide ‚ùå"); return; }
    grantAccess();
    setAccess(true);
    playerNameInput.readOnly = true;
    codeInput.readOnly = true;
    btnValiderCode.disabled = true;
    alert("‚úÖ Acc√®s valid√©. Appuie sur ¬´ Commencer le jeu ¬ª.");
  });

  // Commencer : d√©voile l'√ânigme 1 et active le scanner
  btnCommencer.addEventListener("click", ()=>{
    if(btnCommencer.disabled) return;
    document.getElementById("bloc-enigmes").style.display="block";
    showOnly("enigme1");
    btnScanner.disabled = false;
    if(!startTime) startChrono();
  });

  // Gestion des QR (progression)
  function unlock(id){
    showOnly(id);
    document.getElementById(id).dataset.unlocked="1";
    if(id==="fin"){ const elapsed=Math.floor((Date.now()-startTime)/1000); stopChrono(); /* sauvegarde simple */ }
  }
  function showOnly(id){
    const order=["enigme1","enigme2","enigme3","enigme4","fin"];
    const idx=order.indexOf(id);
    document.querySelectorAll(".enigme").forEach(e=>e.style.display="none");
    for(let i=0;i<=idx;i++){ const el=document.getElementById(order[i]); if(el) el.style.display="block"; }
  }
  function handleQR(value){
    if(!hasAccess()){
      // paywall : renvoi √† l'accueil si on tente un QR sans acc√®s
      alert("Acc√®s requis. Merci d‚Äôenvoyer la preuve de paiement pour obtenir le code.");
      if(location.search.includes("qr=")){ history.replaceState({}, "", location.pathname); }
      return;
    }
    const next = ["enigme2","enigme3","enigme4","fin"].find(step => !document.getElementById(step).dataset.unlocked);
    const expected = (QR_FLOW.find(x=>x.nextId===next)||{}).value;
    if(value===expected){ unlock(next); closeScan(); alert("QR valid√© ‚úÖ"); }
    else { document.getElementById("scanMsg").textContent="QR incorrect ‚ùå"; }
  }

  /* ===== Scanner vid√©o (sans saisie manuelle) ===== */
  const scanModal=document.getElementById("scanModal"), video=document.getElementById("video"),
        btnFermerScan=document.getElementById("btnFermerScan"), scanMsg=document.getElementById("scanMsg");
  let stream=null, detector=null, rafId=null;

  btnScanner.addEventListener("click", openScan);
  btnFermerScan.addEventListener("click", closeScan);

  async function openScan(){
    scanMsg.textContent = "";
    scanModal.style.display = "flex";
    try{
      if('BarcodeDetector' in window){
        detector = new BarcodeDetector({formats:['qr_code']});
      }else{
        // Pas de detector ‚Üí on propose d'utiliser l'appareil photo du t√©l√©phone (QR qui pointe vers ce site)
        scanMsg.textContent = "Scanner int√©gr√© indisponible sur ce t√©l√©phone. Utilise l‚Äôappareil photo : les QR renvoient vers cette page et seront pris en compte automatiquement.";
        return;
      }
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
      video.srcObject = stream; await video.play();
      // petit bonus autofocus/torch si dispo
      const track = stream.getVideoTracks()[0];
      try{ await track.applyConstraints({advanced:[{focusMode:'continuous'}]}); }catch(_){}
      tickScan();
    }catch(e){
      scanMsg.textContent = "Cam√©ra indisponible (permission refus√©e ?).";
    }
  }

  async function tickScan(){
    try{
      const codes = await detector.detect(video);
      if(codes && codes.length){
        const raw = (codes[0].rawValue||"").trim();
        handleQR(raw);
        return; // on arr√™te apr√®s lecture
      }
    }catch(_){}
    rafId = requestAnimationFrame(tickScan);
  }

  function closeScan(){
    scanModal.style.display="none";
    if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }

  /* ===== PAYWALL pour tous les QR scann√©s via l'appareil photo (param ?qr=) ===== */
  (function gateFromURL(){
    const params = new URLSearchParams(location.search);
    const q = params.get("qr");
    if(!q) return;
    if(!hasAccess()){
      // pas d'acc√®s ‚Üí on efface le param et on reste sur l'accueil
      history.replaceState({}, "", location.pathname);
      alert("Acc√®s requis. Merci d‚Äôacheter et valider avant d‚Äôutiliser les QR codes.");
      setAccess(false);
      return;
    }
    // acc√®s OK ‚Üí on consomme le param et on progresse
    history.replaceState({}, "", location.pathname);
    handleQR(q);
  })();

  /* ===== SMS (INARI + compat iOS/Android) ===== */
  const isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);
  const isAndroid=/Android/i.test(navigator.userAgent);
  function buildSmsMessage(){
    const txn=(payerTxn.value||"").trim();
    if(!txn){ alert("Entre ton N¬∞ de paiement PayPal."); return null; }
    return `INARI - Paiement: ${txn}`;
  }
  function smsHref(phone,text){
    const num=phone.replace(/\s+/g,''); const body=encodeURIComponent(text);
    if(isIOS) return `sms:${num}&body=${body}`;
    if(isAndroid) return `smsto:${num}?body=${body}`;
    return `sms:${num}?body=${body}`;
  }
  document.getElementById("btnEnvoyerSMS").addEventListener("click",(e)=>{
    const msg=buildSmsMessage(); if(!msg){e.preventDefault();return;}
    e.currentTarget.setAttribute("href", smsHref(CONTACT_PHONE,msg));
    setTimeout(()=>{ if(document.visibilityState==="visible"){ smsHint.style.display="block"; smsHint.innerHTML=`Si l‚Äôapp SMS ne s‚Äôest pas ouverte, envoie un SMS au <strong>${CONTACT_PHONE}</strong> avec :<br><pre>${msg}</pre>`; } },1200);
  });
</script>
</body>
</html>
