<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jeu de Piste â€“ SchÅ“lcher</title>
<style>
  :root{--blue:#0070ba;--bg:#f7f7f9}
  *{box-sizing:border-box}
  body{font-family:system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:24px;line-height:1.6;color:#111}
  h1,h2,h3{margin:0 0 .6rem}
  p{margin:.25rem 0 .9rem}
  .row{display:flex;gap:.6rem;flex-wrap:wrap;margin:.4rem 0 1rem}
  .btn{display:inline-block;padding:10px 16px;border-radius:10px;text-decoration:none;font-weight:600;border:1px solid #dcdce0;background:#fff;cursor:pointer}
  .btn:hover{background:#eee}
  .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
  .btn.primary[disabled]{opacity:.55;cursor:not-allowed}
  .muted{color:#666;font-size:.95rem}
  .card{background:#fff;border:1px solid #e6e6ea;border-radius:14px;padding:16px;margin-top:16px}
  input[type=text],input[type=email]{padding:10px 12px;border:1px solid #dcdce0;border-radius:10px;min-width:260px}
  .badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;border:1px solid #ccc;font-size:.85rem}
  .ok{background:#e9fbe9;border-color:#bfe9bf;color:#164a16}
  .ko{background:#fff4f4;border-color:#ffd7d7;color:#7b1a1a}

  /* Carte */
  .map-wrap{position:relative;width:100%;overflow:auto;background:#fafafa;border:1px solid #e6e6ea;border-radius:14px}
  .map-frame{width:100%;height:min(80vh,700px);display:flex;align-items:center;justify-content:center}
  .map-img{max-height:100%;max-width:100%;display:block;transition:transform .2s ease}
  .map-tools{position:absolute;right:12px;top:12px;display:flex;gap:6px}

  .enigme{display:none}
  .enigme.active{display:block}
  .hr{height:1px;background:#ececf2;margin:16px 0}
  footer{margin-top:28px;color:#555;font-size:.9rem}

  /* Scanner */
  #scanModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
  #scanBox{background:#fff;border-radius:12px;max-width:520px;width:100%;padding:16px}
  video{width:100%;border-radius:10px;border:1px solid #e6e6ea}
</style>
</head>
<body>
  <header>
    <h1>Jeu de Piste â€“ SchÅ“lcher</h1>
    <p>Munis-toi de papier et crayon, scanne les QR codes et rÃ©sous les Ã©nigmes.</p>
    <p>Le jeu coÃ»te 10 â‚¬ â€” lâ€™accÃ¨s sâ€™active aprÃ¨s paiement ou code dâ€™accÃ¨s.</p>
  </header>

  <!-- ACCÃˆS -->
  <section class="card" id="acces">
    <h2>AccÃ¨s au jeu</h2>
    <div class="row">
      <a class="btn primary" target="_blank" rel="noopener"
         href="https://www.paypal.com/ncp/payment/GLM2FB7ERYXKQ">ğŸ’³ Payer 10 â‚¬ (PayPal)</a>

      <input type="text" id="codeInput" placeholder="Entrer le code dâ€™accÃ¨s" />
      <button class="btn" id="btnValiderCode">Valider le code</button>
    </div>

    <div class="row">
      <input type="text"  id="payerName"  placeholder="Nom / PrÃ©nom" />
      <input type="email" id="payerEmail" placeholder="Email" />
      <input type="text"  id="payerTxn"   placeholder="NÂ° de paiement PayPal" />
      <button class="btn" id="btnEnvoyerPreuve">Envoyer la preuve</button>
    </div>

    <p class="muted">Statut : <span id="badge" class="badge ko">verrouillÃ©</span></p>
    <div class="hr"></div>

    <div class="row">
      <button class="btn primary" id="btnCommencer" disabled>Commencer le jeu</button>
      <button class="btn" id="btnScanner" disabled>Scanner le QR code</button>
    </div>
    <p class="muted">Le scanner se dÃ©bloque aprÃ¨s lâ€™accÃ¨s. Chaque Ã©nigme suivante nâ€™apparaÃ®t quâ€™aprÃ¨s le scan du bon QR.</p>
  </section>

  <!-- TA CARTE -->
  <section class="card">
    <h2>Carte du parcours</h2>
    <p class="muted">Si la carte est mal orientÃ©e, clique sur â€œTourner la carteâ€.</p>
    <div class="map-wrap">
      <div class="map-tools">
        <button class="btn" id="rotateLeft">â†º Tourner la carte</button>
        <a class="btn" download href="carte-schoelcher.jpg">TÃ©lÃ©charger</a>
      </div>
      <div class="map-frame">
        <img class="map-img" id="mapImg" src="carte-schoelcher.jpg" alt="Carte du jeu de piste Ã  SchÅ“lcher">
      </div>
    </div>
  </section>

  <!-- Ã‰NIGMES -->
  <section id="bloc-enigmes" class="card" style="display:none;">
    <h2>Ã‰nigmes</h2>
    <p class="muted">Seule lâ€™Ã‰nigme 1 est visible au dÃ©part. Les suivantes se dÃ©bloquent en scannant le bon QR.</p>

    <!-- 1 visible aprÃ¨s dÃ©verrouillage accÃ¨s -->
    <article id="enigme1" class="enigme">
      <h3>Ã‰nigme 1</h3>
      <p><em>(ğŸ‘‰ Remplace ce texte par TON Ã‰NIGME 1)</em></p>
      <p class="muted">Scanne le QR â€œENIGME-2â€ pour afficher la suivante.</p>
    </article>

    <article id="enigme2" class="enigme">
      <h3>Ã‰nigme 2</h3>
      <p><em>(ğŸ‘‰ TON Ã‰NIGME 2)</em></p>
      <p class="muted">Scanne le QR â€œENIGME-3â€.</p>
    </article>

    <article id="enigme3" class="enigme">
      <h3>Ã‰nigme 3</h3>
      <p><em>(ğŸ‘‰ TON Ã‰NIGME 3)</em></p>
      <p class="muted">Scanne le QR â€œENIGME-4â€.</p>
    </article>

    <article id="enigme4" class="enigme">
      <h3>Ã‰nigme 4</h3>
      <p><em>(ğŸ‘‰ TON Ã‰NIGME 4)</em></p>
      <p class="muted">Scanne le QR â€œFINâ€.</p>
    </article>

    <article id="fin" class="enigme">
      <h3>Bravo ğŸ‰</h3>
      <p>Tu as terminÃ© le parcours !</p>
      <a class="btn" href="#" onclick="window.scrollTo({top:0,behavior:'smooth'})">Retour Ã  lâ€™accueil</a>
    </article>
  </section>

  <!-- MODAL SCAN -->
  <div id="scanModal" role="dialog" aria-modal="true">
    <div id="scanBox">
      <h3>Scanner un QR code</h3>
      <p class="muted">Autorise la camÃ©ra. Si Ã§a ne marche pas, saisis le code manuellement.</p>
      <video id="video" playsinline muted></video>
      <div class="row">
        <input type="text" id="qrManual" placeholder="Saisir le code QR manuellement" />
        <button class="btn" id="btnValiderQR">Valider</button>
        <button class="btn" id="btnFermerScan">Fermer</button>
      </div>
      <p id="scanMsg" class="muted"></p>
    </div>
  </div>

  <footer>
    <span class="muted">Besoin que je remplace les textes par tes Ã©nigmes exactes ? Dis-les moi et je te renvoie ce fichier rempli.</span>
  </footer>

  <script>
    // =============== CONFIG Ã€ PERSONNALISER ===============
    const CONTACT_EMAIL = "ton.email@example.com";   // â† TON email pour recevoir la preuve
    const ACCESS_CODE   = "SCHOELCHER-10";           // â† Code que TU donnes aprÃ¨s vÃ©rif du paiement
    const LS_KEY        = "jp_schoelcher_unlocked_v2";

    // Suite attendue des QR (valeurs EXACTES Ã  encoder dans tes QR)
    // Remplace "ENIGME-2", etc. par tes vraies valeurs.
    const QR_FLOW = [
      { nextId:"enigme2", value:"ENIGME-2" },
      { nextId:"enigme3", value:"ENIGME-3" },
      { nextId:"enigme4", value:"ENIGME-4" },
      { nextId:"fin",     value:"FIN" }
    ];
    // =============== FIN CONFIG ===============

    // Ã‰TAT / RÃ‰F
    const badge = document.getElementById("badge");
    const btnCommencer = document.getElementById("btnCommencer");
    const btnScanner = document.getElementById("btnScanner");
    const blocEnigmes = document.getElementById("bloc-enigmes");
    const codeInput = document.getElementById("codeInput");
    const btnValiderCode = document.getElementById("btnValiderCode");
    const btnEnvoyerPreuve = document.getElementById("btnEnvoyerPreuve");
    const scanModal = document.getElementById("scanModal");
    const video = document.getElementById("video");
    const qrManual = document.getElementById("qrManual");
    const btnValiderQR = document.getElementById("btnValiderQR");
    const btnFermerScan = document.getElementById("btnFermerScan");
    const scanMsg = document.getElementById("scanMsg");
    const mapImg = document.getElementById("mapImg");
    const rotateLeft = document.getElementById("rotateLeft");

    // INIT ACCÃˆS
    setAccess(localStorage.getItem(LS_KEY) === "1");

    // Commencer montre seulement Ã©nigme 1 au dÃ©part
    btnCommencer.addEventListener("click", () => {
      if (btnCommencer.disabled) return;
      blocEnigmes.style.display = "block";
      showOnly("enigme1");
      blocEnigmes.scrollIntoView({behavior:"smooth"});
      btnScanner.disabled = false;
    });

    // Valider code accÃ¨s
    btnValiderCode.addEventListener("click", () => {
      const v = (codeInput.value || "").trim();
      if (!v) return alert("Entre le code dâ€™accÃ¨s.");
      if (v === ACCESS_CODE) {
        setAccess(true);
        alert("Code valide âœ… AccÃ¨s dÃ©verrouillÃ©.");
      } else {
        alert("Code invalide âŒ");
      }
    });

    // Envoyer preuve paiement (mailto)
    btnEnvoyerPreuve.addEventListener("click", () => {
      const name = (document.getElementById("payerName").value||"").trim();
      const email= (document.getElementById("payerEmail").value||"").trim();
      const txn  = (document.getElementById("payerTxn").value||"").trim();
      if(!txn) return alert("Entre ton NÂ° de paiement PayPal.");
      const subject = encodeURIComponent("Preuve de paiement â€“ Jeu de Piste SchÅ“lcher");
      const body = encodeURIComponent(
        `Bonjour,\n\nVoici ma preuve de paiement :\n- Nom : ${name}\n- Email : ${email}\n- NÂ° de paiement PayPal : ${txn}\n\nMerci de mâ€™envoyer le code dâ€™accÃ¨s.\n`
      );
      window.location.href = `mailto:${encodeURIComponent(CONTACT_EMAIL)}?subject=${subject}&body=${body}`;
    });

    // Scanner modal
    let stream, detector;
    btnScanner.addEventListener("click", openScan);
    btnFermerScan.addEventListener("click", closeScan);
    btnValiderQR.addEventListener("click", () => {
      const v = (qrManual.value||"").trim();
      if(!v){ scanMsg.textContent = "Entre un code."; return; }
      handleQR(v);
    });

    async function openScan(){
      scanMsg.textContent = "";
      scanModal.style.display = "flex";
      try {
        if ('BarcodeDetector' in window) {
          detector = new BarcodeDetector({formats:['qr_code']});
        }
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream;
        await video.play();
        if (detector) requestAnimationFrame(tick);
      } catch(e) {
        scanMsg.textContent = "CamÃ©ra indisponible. Utilise la saisie manuelle.";
      }
    }

    async function tick(){
      try{
        const barcodes = await detector.detect(video);
        if (barcodes.length){
          const v = (barcodes[0].rawValue||"").trim();
          handleQR(v);
          return;
        }
      }catch(e){}
      if (scanModal.style.display === "flex") requestAnimationFrame(tick);
    }

    function closeScan(){
      scanModal.style.display = "none";
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    }

    // Traite un QR scannÃ©
    function handleQR(value){
      // Cherche la prochaine Ã©tape non dÃ©bloquÃ©e
      const unlocked = getUnlocked();
      const nextItem = QR_FLOW.find(item => !unlocked.includes(item.nextId));
      if (!nextItem){
        scanMsg.textContent = "Tout est dÃ©jÃ  dÃ©bloquÃ© âœ…";
        closeScan();
        return;
      }
      if (value === nextItem.value){
        unlock(nextItem.nextId);
        closeScan();
        alert("QR validÃ© âœ…");
      } else {
        scanMsg.textContent = "QR incorrect pour cette Ã©tape âŒ";
      }
    }

    // DÃ©verrouillage / stockage
    function getUnlocked(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY+"_unlocked")||"[]"); }catch(_){ return []; }
    }
    function setUnlocked(list){
      localStorage.setItem(LS_KEY+"_unlocked", JSON.stringify(list));
    }
    function unlock(id){
      const list = getUnlocked();
      if(!list.includes(id)) list.push(id);
      setUnlocked(list);
      showOnly(id);
    }

    // Affiche uniquement lâ€™Ã©nigme demandÃ©e + toutes les prÃ©cÃ©dentes dÃ©bloquÃ©es
    function showOnly(id){
      const order = ["enigme1","enigme2","enigme3","enigme4","fin"];
      const unlocked = new Set(getUnlocked());
      unlocked.add("enigme1"); // la 1 est autorisÃ©e dÃ¨s le dÃ©but du jeu
      const targetIndex = order.indexOf(id);
      document.querySelectorAll(".enigme").forEach(e => e.style.display="none");
      for(let i=0;i<=targetIndex;i++){
        const eid = order[i];
        const el = document.getElementById(eid);
        if (el) el.style.display = "block";
      }
    }

    // Verrouillage global
    function setAccess(ok){
      if (ok) {
        localStorage.setItem(LS_KEY, "1");
        btnCommencer.disabled = false;
        badge.textContent = "dÃ©verrouillÃ©";
        badge.classList.remove("ko"); badge.classList.add("ok");
      } else {
        localStorage.removeItem(LS_KEY);
        localStorage.removeItem(LS_KEY+"_unlocked");
        btnCommencer.disabled = true;
        btnScanner.disabled = true;
        badge.textContent = "verrouillÃ©";
        badge.classList.remove("ok"); badge.classList.add("ko");
        blocEnigmes.style.display = "none";
      }
    }

    // Carte : rotation si nÃ©cessaire
    let rot = 0;
    rotateLeft.addEventListener("click", ()=>{
      rot = (rot - 90) % 360;
      mapImg.style.transform = `rotate(${rot}deg)`;
    });
  </script>
</body>
</html>
